#!/bin/bash

# RZD Bot - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
# ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ .env Ñ„Ð°Ð¹Ð»Ð° Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ Ð±Ð¾Ñ‚Ð°

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ³Ð¾ .env Ñ„Ð°Ð¹Ð»Ð°
check_existing_env() {
    if [[ -f ".env" ]]; then
        print_warning "Ð¤Ð°Ð¹Ð» .env ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
        echo "Ð¢ÐµÐºÑƒÑ‰ÐµÐµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ:"
        echo "=================="
        cat .env
        echo "=================="
        echo
        read -p "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_status "ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼"
            exit 0
        fi
    fi
}

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð±Ð¾Ñ‚Ð°
get_bot_token() {
    echo
    print_status "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ RZD Bot"
    echo
    echo "Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð±Ð¾Ñ‚Ð° Ð½ÑƒÐ¶ÐµÐ½ Ñ‚Ð¾ÐºÐµÐ½ Ð¾Ñ‚ @BotFather Ð² Telegram:"
    echo "1. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ @BotFather Ð² Telegram"
    echo "2. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ /newbot"
    echo "3. Ð¡Ð»ÐµÐ´ÑƒÐ¹Ñ‚Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð±Ð¾Ñ‚Ð°"
    echo "4. Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½"
    echo
    
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‚Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð°: " BOT_TOKEN
    
    if [[ -z "$BOT_TOKEN" ]]; then
        print_error "Ð¢Ð¾ÐºÐµÐ½ Ð±Ð¾Ñ‚Ð° Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        exit 1
    fi
    
    # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
    if [[ ! "$BOT_TOKEN" =~ ^[0-9]+:[A-Za-z0-9_-]+$ ]]; then
        print_warning "Ð¢Ð¾ÐºÐµÐ½ Ð²Ñ‹Ð³Ð»ÑÐ´Ð¸Ñ‚ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾!"
        print_warning "Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ: 1234567890:ABCdefGHIjklMNOpqrsTUVwxyz"
        read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
}

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð¼ÐµÐ½Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
get_domain() {
    echo
    read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð¾Ð¼ÐµÐ½ Ð´Ð»Ñ Ð²ÐµÐ±-Ñ…ÑƒÐºÐ° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ): " DOMAIN
    
    if [[ -n "$DOMAIN" ]]; then
        WEBHOOK_URL="https://$DOMAIN/webhook"
        print_status "Ð’ÐµÐ±-Ñ…ÑƒÐº Ð±ÑƒÐ´ÐµÑ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ Ð½Ð°: $WEBHOOK_URL"
    else
        WEBHOOK_URL=""
        print_status "Ð’ÐµÐ±-Ñ…ÑƒÐº Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½ (Ð±ÑƒÐ´ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ polling)"
    fi
}

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
create_env_file() {
    print_status "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° .env..."
    
    cat > .env << EOF
# Telegram Bot
TELEGRAM_BOT_TOKEN=$BOT_TOKEN
TELEGRAM_WEBHOOK_URL=$WEBHOOK_URL

# Database
DATABASE_URL=postgresql://rzd_user:rzd_secure_password_2024@localhost:5432/rzd_bot
REDIS_URL=redis://localhost:6379/0

# RZD Settings
RZD_BASE_URL=https://pass.rzd.ru
SCRAPING_DELAY=5
MAX_CONCURRENT_REQUESTS=3

# Monitoring
CHECK_INTERVAL_MINUTES=10
MAX_SUBSCRIPTIONS_PER_USER=5

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/bot.log
EOF

    print_success "Ð¤Ð°Ð¹Ð» .env ÑÐ¾Ð·Ð´Ð°Ð½"
}

# ÐŸÐ¾ÐºÐ°Ð· Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
show_info() {
    echo
    print_success "ðŸŽ‰ ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°!"
    echo
    echo "ðŸ“‹ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» .env:"
    echo "========================"
    cat .env
    echo "========================"
    echo
    echo "ðŸš€ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
    echo "1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð°: ./quick_start.sh"
    echo "2. Ð˜Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Docker: docker-compose up -d"
    echo "3. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ Ð±Ð¾Ñ‚Ð° Ð² Telegram Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /start"
    echo
    if [[ -n "$DOMAIN" ]]; then
        echo "ðŸŒ Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°:"
        echo "sudo ./setup_domain.sh"
    fi
    echo
    print_warning "âš ï¸  ÐÐµ Ð´ÐµÐ»Ð¸Ñ‚ÐµÑÑŒ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ Ð±Ð¾Ñ‚Ð° Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼Ð¸!"
}

# ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ
main() {
    echo "âš™ï¸ RZD Bot - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸"
    echo "=================================="
    echo
    
    check_existing_env
    get_bot_token
    get_domain
    create_env_file
    show_info
}

# Ð—Ð°Ð¿ÑƒÑÐº
main "$@"

